########################## PREROUTING & POSTROUTING ##########################

PREROUTING: regole da applicare appena il pacchetto entra, nelle catene PREROUTING o OUTPUT
– il target DNAT indica a netfilter che deve essere modificato l’indirizzo didestinazione del pacchetto
– l’opzione --to-destination [ipaddr[-ipaddr]][:port[-port]] permette di specificare la nuova destinazione
– il target REDIRECT funziona come DNAT ma è necessario se si vuole specificamente ridirigere il pacchetto alla macchina locale
– l’opzione --to-ports permette di cambiare la porta di destinazione 

POSTROUTING: regole da applicare a un pacchetto appena prima che lasci il sistema, nelle catene POSTROUTING o INPUT
– il target SNAT indica a netfilter che deve essere modificato l’indirizzo di sorgente del pacchetto
– l’opzione --to-source [ipaddr[-ipaddr]][:port[-port]] permette di specificare la nuova sorgente
– il target MASQUERADE (valido solo in POSTROUTING) funziona come SNAT assegnando automaticamente al pacchetto l’indirizzo dell’interfaccia di uscita




########################## COME FUNZIONANO I NAT ##########################
Esempio : abbiamo architettura host – router – internet
Nel traffico internet -> host router deve cambiare indirizzo di destinazione facendo quindi
DNAT –to-destination [indirizzo dell’host]
Nel traffico host->internet router deve cambiare indirizzo sorgente facendo quindi SNAT –to-
source [indirizzo del router]

########################## CLIENT PRIVATO E SERVER PUBBLICO ##########################
Nel caso di rete privata client e rete pubblica server
1. accesso da parte dei client alla porta TCP 993 del server
iptables -t nat -A POSTROUTING -s 172.20.0.0/20 -d 1.1.1.14 -j SNAT --to-source 1.1.1.1
iptables -A FORWARD -p tcp -s 172.20.0.0/20 -d 1.1.1.14 -i eth1 -o eth2 --dport 993 -j ACCEPT
iptables -A FORWARD -p tcp -s 1.1.1.14 -d 1.1.1.1 -i eth2 -o eth1 --sport 993 -m state --state ESTABLISHED -j ACCEPT


########################## ESEMPI ##########################
#1. I Client sulla rete privata 192.168.0.0/24 devono poter interrogare DNS e 
#   servizi di sincronizzazione NTP in Internet (porte UDP 53 e 1233)
iptables -A FORWARD -p udp -i eth3 -o eth1 -d 192.168.0.0/24 --sport 53 -j ACCEPT
iptables -A FORWARD -p udp -o eth3 -i eth1 -s 192.168.0.0/24 --dport 53 -m state --state ESTABLISHED -j ACCEPT
iptables -A FORWARD -p udp -i eth3 -o eth1 -d 192.168.0.0/24 --sport 123 -j ACCEPT
iptables -A FORWARD -p udp -o eth3 -i eth1 -s 192.168.0.0/24 --dport 123 -m state --state ESTABLISHED -j ACCEPT

#Uso la tabella nat e inserisco nella catena di postrouting un target SNAT che permette di cambiare l'indirizzo sorgente
# di un pacchetto, tradotto: i pacchetti del client(richieste dns/ntp configurati prima) hanno accesso a "internet" quindi
# verranno modificati in modo che l'indirizzo IP sorgente sia 130.136.5.15. Questo è utile quando si desidera nascondere 
# gli indirizzi IP interni dietro un indirizzo IP pubblico per il routing su Internet o per altri scopi di sicurezza e 
# gestione del traffico.
iptables -t nat -A POSTROUTING -p tcp -i eth1 -s 192.168.0.0/24 -o eth3 -j SNAT --to-source 130.136.5.15


#2. Il servizio SMTP (porta 25 tcp ) del Server collocato sulla rete privata 
#   172.16.0.0/20 deve essere raggiungibile da qualsiasi host di Internet
iptables -t nat -A PREROUTING -p tcp -i eth3 -s 130.136.5.15 --dport 25 -o eth1 -j DNAT --to-destination 172.16.0.1
iptables -A FORWARD -p tcp -i eth3 -o eth2 -d 172.16.0.1 --dport 25 -j ACCEPT
iptables -A FORWARD -p tcp -o eth3 -i eth2 -s 172.16.0.1 --sport 25 -m state --state ESTABLISHED -j ACCEPT

###########################################################################################