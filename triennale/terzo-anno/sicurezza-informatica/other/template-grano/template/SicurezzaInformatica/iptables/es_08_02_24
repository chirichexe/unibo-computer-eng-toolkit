#Fate riferimento all'esercizio su Intrusion Detection, 
#dopo aver individuato l'attacco, gli altri tipi di traffico presenti nel tracciato sono da considerare legittimi.
#Consegnate un file  ipt.sh  coi comandi che permettano di configurare 
#il packet filter del router per consentire unicamente tali interazioni.


# flush per partire puliti
iptables -F INPUT
iptables -F OUTPUT
iptables -F FORWARD

# router = server dhcp per le tre reti
iptables -I INPUT -p udp --sport 68 --dport 67 -j ACCEPT
iptables -I OUTPUT -p udp --dport 68 --sport 67 -m state --state ESTABLISHED -j ACCEPT


# router = server dns per rete .3 
iptables -I INPUT -p udp -s 172.23.3.187 -d 172.23.3.1 --dport 53 -j ACCEPT
iptables -I OUTPUT -p udp -d 172.23.3.187 -s 172.23.3.1 --sport 53 -m state --state ESTABLISHED -j ACCEPT

# host su rete 3 = server NTP per client su rete 2
iptables -I FORWARD -p udp -s 172.22.2.159 -d 172.23.3.187 --dport 123 --sport 123 -j ACCEPT
iptables -I FORWARD -p udp -d 172.22.2.159 -s 172.23.3.187 --dport 123 --sport 123 -m state --state ESTABLISHED -j ACCEPT

# host su rete 3 = server ssh per client su rete 2
iptables -I FORWARD -p tcp -s 172.22.2.159 -d 172.23.3.187 --dport 22 -j ACCEPT
iptables -I FORWARD -p tcp -d 172.22.2.159 -s 172.23.3.187 --sport 22 -m state --state ESTABLISHED -j ACCEPT

# host su rete 2 = server POP per client su rete 1
iptables -I FORWARD -p tcp -s 172.21.1.118 -d 172.22.2.159 --dport 110 -j ACCEPT
iptables -I FORWARD -p tcp -d 172.21.1.118 -s 172.22.2.159 --sport 110 -m state --state ESTABLISHED -j ACCEPT

# host su rete 2 = server IMAPS per client su rete 1
iptables -I FORWARD -p tcp -s 172.21.1.118 -d 172.22.2.159 --dport 993 -j ACCEPT
iptables -I FORWARD -p tcp -d 172.21.1.118 -s 172.22.2.159 --sport 993 -m state --state ESTABLISHED -j ACCEPT

# detfault deny tranne loopback (e per il contesto virtualbox, eth0)
iptables -I INPUT -i lo -j ACCEPT
iptables -I OUTPUT -o lo -j ACCEPT
iptables -I INPUT -i eth0 -j ACCEPT
iptables -I OUTPUT -o eth0 -j ACCEPT

iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP