Client : 172.20.0.0/24 (eth1)
Router : 172.20.15.254 (eth1)
Router : 1.1.1.1 (eth2) rete 1.1.1.0/28
Router : 137.204.1.15 (eth3)
Server : 1.1.1.14 (eth1)


#Client
iptables -F INPUT #Pulisco le regole di input
iptables -F OUTPUT #Pulisco le regole di output
iptables -F FORWARD #Pulisco le regole di forwarding

iptables -A OUTPUT -p tcp --dport 993 -d 1.1.1.14 -o eth1 -j ACCEPT
iptables -A INPUT -p tcp --sport 993 -m state --state ESTABLISHED -s 1.1.1.14 -d 172.20.0.0/24 -i eth1 -j ACCEPT

iptables -A OUTPUT -p tcp --dport 443 -o eth1 -j ACCEPT
iptables -A INPUT -p tcp --sport 443 -m state --state ESTABLISHED -d 172.20.0.0/24 -i eth1 -j ACCEPT

#Accesso alla porta 53 UDP del router
iptables -A OUTPUT -p udp --dport 53 -d 172.20.15.254 -o eth1 -j ACCEPT
iptables -A INPUT -p udp --sport 53 -s 172.20.15.254 -i eth1 -j ACCEPT

iptables -P INPUT DROP 
iptables -P OUTPUT DROP
iptables -P FORWORD DROP

#Router
iptables -A FORWARD -p tcp --dport 993 -s 172.20.0.0/24 -d 1.1.1.14 -i eth1 -o eth2 -j ACCEPT
iptables -A FORWARD -p tcp --sport 993 -m state --state ESTABLISHED -s1.1.1.14 -d 172.20.0.0/24 -i eth2 -o eth1 -j ACCEPT

iptables -A FORWARD -p tcp --dport 25 -d 1.1.1.14 -i eth3 -o eth2 -j ACCEPT
iptables -A FORWARD -p tcp --sport 25 -m state --state ESTABLISHED -s 1.1.1.14  -i eth2 -o eth3 -j ACCEPT

iptables -A FORWARD -p tcp --dport 443 -s 172.20.0.0/24 -i eth1  -j ACCEPT
iptables -A FORWARD -p tcp --sport 443 -m state --state ESTABLISHED -d 172.20.0.0/24 -i eth3 -o eth1 -j ACCEPT

iptables -A INPUT -p udp --sport 53 -s 172.20.0.0/24 -d 172.20.15.254 -i eth1 -j ACCEPT
iptables -A OUTPUT -p udp --dport 53 -s 172.20.15.254 -d 172.20.0.0/24 -o eth1 -j ACCEPT

iptables -P INPUT DROP 
iptables -P OUTPUT DROP
iptables -P FORWORD DROP

#Server
iptables -A INPUT -p tcp --sport 25 -d 1.1.1.14 -i eth1 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 22 -m state --state ESTABLISHED -s 10.3.3.1 -d 10.1.1.1 -o eth1 -j ACCEPT

iptables -P INPUT DROP 
iptables -P OUTPUT DROP
iptables -P FORWORD DROP
