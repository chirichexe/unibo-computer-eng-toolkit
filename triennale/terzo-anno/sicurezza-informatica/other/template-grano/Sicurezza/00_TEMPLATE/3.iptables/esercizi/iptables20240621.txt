#Esercizio 2 - iptables

############ ROUTER ############

iptables -F INPUT
iptables -F OUTPUT
iptables -F FORWARD
iptables -t nat -F PREROUTING
iptables -t nat -F POSTROUTING

iptables -I INPUT -i lo -j ACCEPT 
iptables -I OUTPUT -o lo -j ACCEPT 

#Le interazioni consentite nella rete raffigurata devono essere unicamente:
#accesso da parte dei client con IMAP/S a mail server su internet (porta TCP 993)
iptables -t nat -A POSTROUTING -p tcp -i eth1 -o eth3 -s 172.20.0.0/20 --dport 993 -j SNAT --to-source 137.204.1.15
iptables -A FORWARD -p tcp -s 172.20.0.0/20 -i eth1 -o eth3 --dport 993 -j ACCEPT
iptables -A FORWARD -p tcp -d 172.20.0.0/20 -o eth1 -i eth3 --sport 993 -m state --state ESTABLISHED -j ACCEPT



#accesso da parte di qualsiasi host su internet alla porta TCP 443 del server
iptables -t nat -A PREROUTING -p tcp -i eth3 -o eth2 -s 137.204.1.15 --dport 443 -j DNAT --to-destination 1.1.1.14
iptables -A FORWARD -p tcp -d 1.1.1.14 -i eth3 -o eth2 --dport 443 -j ACCEPT
iptables -A FORWARD -p tcp -s 1.1.1.14 -o eth3 -i eth2 --sport 443 -m state --state ESTABLISHED -j ACCEPT


#accesso da parte dei client alla porta UDP 53 del router
iptables -A INPUT -p udp -s 172.20.0.0/20 -i eth1 --dport 53 -j ACCEPT
iptables -A OUTPUT -p udp -d 172.20.0.0/20 -o eth1 --sport 53 -m state --state ESTABLISHED -j ACCEPT


#accesso da parte del server agli agent SNMP dei client (porta UDP 161)
iptables -t nat -A POSTROUTING -s 172.20.0.0/20 -d 1.1.1.14 -j SNAT --to-source 1.1.1.1
iptables -A FORWARD -p udp -s 172.20.0.0/20 -d 1.1.1.14 -i eth1 -o eth2 --dport 161 -j ACCEPT
iptables -A FORWARD -p udp -d 172.20.0.0/20 -s 1.1.1.14 -o eth1 -i eth2 --sport 161 -m state --state ESTABLISHED -j ACCEPT

iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP

############ CLIENT ############

iptables -F INPUT
iptables -F OUTPUT

iptables -I INPUT -i lo -j ACCEPT 
iptables -I OUTPUT -o lo -j ACCEPT 

#Le interazioni consentite nella rete raffigurata devono essere unicamente:
#accesso da parte dei client con IMAP/S a mail server su internet (porta TCP 993)
iptables -A OUTPUT -p tcp -o eth1 --dport 993 -j ACCEPT
iptables -A INPUT -p tcp -i eth1 --sport 993 -m state --state ESTABLISHED -j ACCEPT


#accesso da parte di qualsiasi host su internet alla porta TCP 443 del server
#NIENTE DA CONFIGURARE SU CLIENT

#accesso da parte dei client alla porta UDP 53 del router
iptables -A INPUT -p udp -s 172.20.15.254 -i eth1 --sport 53 -m state --state ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p udp -d 172.20.15.254 -o eth1 --dport 53 -j ACCEPT


#accesso da parte del server agli agent SNMP dei client (porta UDP 161)
iptables -A INPUT -p udp -s 1.1.1.1 -i eth1 --dport 161 -j ACCEPT
iptables -A OUTPUT -p udp -d 1.1.1.1 -o eth1 --sport 161 -m state --state ESTABLISHED -j ACCEPT

iptables -P INPUT DROP
iptables -P OUTPUT DROP










