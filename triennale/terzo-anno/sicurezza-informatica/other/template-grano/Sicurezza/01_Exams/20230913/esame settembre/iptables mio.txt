1) i Client sulla rete privata 192.168.0.0/24 devono poter interrogare DNS e servizi di sincronizzazione NTP in Internet (porte UDP 53 e 1233)

Client
(ANDATA)	
iptables -A OUTPUT -s 192.168.0.0/24 -o eth1 -p UDP --dport 53 -j ACCEPT   	#porta 53
iptables -A OUTPUT -s 192.168.0.0/24 -o eth1 -p UDP --dport 1233 -j ACCEPT    	#porta 1233

(RITORNO)
iptables -A INPUT -d 192.168.0.0/24 -i eth1 -p UDP --dport 53 -m state --state ESTABLISHED -j ACCEPT     #porta 53
iptables -A INPUT -d 192.168.0.0/24 -i eth1 -p UDP --dport 1233 -m state --state ESTABLISHED -j ACCEPT   #porta 1233


Router
#porta 53
iptables -A FORWARD -s 192.168.0.0/24 -p UDP -i eth1 -o eth3 --dport 53 -j ACCEPT (andata)
iptables -A FORWARD -d 10.1.1.0/24 -p tcp -i eth3 -o eth1--sport 993 -m state –state ESTABLISHED -j ACCEPT (ritorno)

#porta 1233
iptables -A FORWARD -s 192.168.0.0/24 -p UDP -i eth1 -o eth3 --dport 1233 -j ACCEPT (andata)
iptables -A FORWARD -d 10.1.1.0/24 -p tcp -i eth3 -o eth1--sport 1233 -m state –state ESTABLISHED -j ACCEPT (ritorno)



2) il servizio SMTP (porta 25 tcp) del Server collocato sulla rete privata 172.16.0.0/20 deve essere raggiungibile da qualsiasi host di Internet

Server
(Andata)
iptables -A OUTPUT -s 172.16.0.0/20 -o eth1 -p TCP --dport 25 -j ACCEPT   
(Ritorno)
iptables -A INPUT -d 172.16.0.0/20 -i eth1 -p TCP --dport 25 -m state --state ESTABLISHED -j ACCEPT

Router
(la destination nat va messa nella catena di PREROUTING: prima di passare il pacchetto, li cambio la destinazione)
iptables -t nat -A PREROUTING -i eth3 -d 130.136.5.15 -p tcp --dport 25 -j DNAT --to-destination 172.16.0.1

(questo target opera una modifica sul pacchetto ma NON consente direttamente il transito perché sono due cose separate, quindi ci vuole un’altra regola di inoltro)
iptables -A FORWARD -i eth3 -d 172.16.0.1 -p tcp --dport 25 -j ACCEPT

iptables -A FORWARD -o eth3 -s 172.16.0.1 -p tcp --sport 25 -m state --state ESTABLISHED -j ACCEPT



3) il servizio LDAP (porta 389 tcp) del Router deve essere raggiungibile dal Server

Server:
iptables -A OUTPUT -s 172.16.15.254 -o eth1 -p tcp --dport 389 -j ACCEPT

...qui devo controllare che possano entrare
iptables -A INPUT -d 172.16.15.254 -i eth1 -p tcp --dport 389 -m state --state ESTABLISHED -j ACCEPT

R:
(R è un server SSH e quindi se vedo arrivare in ingresso un pacchetto da 172.16.15.254 prot tcp, lo accetto e produco la risposta)
iptables -A INPUT -d 172.16.15.254 -i eth2 -p tcp --dport 389 -j ACCEPT
iptables -A OUTPUT -s 172.16.15.254 -o eth2 -p tcp --sport 389 -m state --state ESTABLISHED -j ACCEPT


